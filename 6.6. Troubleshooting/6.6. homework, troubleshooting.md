# Домашнее задание к занятию "6.6. Troubleshooting"
##Задача 1

Напишите список операций, которые вы будете производить для остановки запроса пользователя (нужно прервать CRUD операцию в MongoDB)

Ответ:
```text
Раздел Terminate Running Operations по предложенной ссылке говорит о том, что можно установить лимит времени для операций, а если надо прервать операцию, то поможет команда `db.killOp`.
Текущие операции покажет метод db.currentOp()
```

Предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

Ответ:
```text
Можно применить метод maxTimeMS() для установки лимита по времени. Тогда операция будет прервана в следующей точки прерывания (interrupt point).
Кроме того нужно отловить долгие запросы с помощью db.currentOp(), потом проверить план пойманного долгого запроса с помощью explain('executionStats'). И перестроить индексы.
```

##Задача 2
Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи
Как вы думаете, в чем может быть проблема?

Ответ:
```text
Думаю, что не достаточно оперативной памяти и swap. Если просто не хватает оперативной памяти, что будет задержка в работе, о чём говорится в предложенной статье.
Или, быть может, на диске не осталось места.
```

##Задача 3
Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы, пользователи начали жаловаться на ошибки вида:
`InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '`
Как вы думаете, почему это начало происходить и как локализовать проблему?
Какие пути решения данной проблемы вы можете предложить?

Ответ:
```text
В предложенной документации сказано, что может быть несколько причин:
Одна из них - проблема с сетью. Если проблема возникает часто, надо проверить сеть.
Далее, причиной может быть большое количество данных, пересылаемых при выполнении запроса. В таком случае надо увеличить net_read_timeout со стандартных 30 секунд жо минуты и более, если известно, что тяжёлые запросы есть.
Ещё может помочь увеличение connect_timeout если имеем медленное соединение.
Далее, надо отловить тяжелые запросы и с помощью explain проверить, почему они долго выполняются. И оптимизировать их. Возможно, добавить индексы.
Ну и следует убедиться, что машине вообще хватает ресурсов.
```

##Задача 4
Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объемом данных лучше, чем MySQL.
После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:
`postmaster invoked oom-killer`
Как вы думаете, что происходит?
Как бы вы решили данную проблему?

Ответ:
```text
Если срабатывает oom-killer, значит на машине не осталось памяти.
Надо:
1. Увеличить оперативную память не железе и/или виртуальной машине;
2. Поставить лимит на использование памяти для Postgres.
Тогда ОС перестанет убивать процесс.
```
